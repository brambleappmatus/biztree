generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(cuid())
  name               String?
  email              String    @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  role               String    @default("USER") // USER, ADMIN, SUPER_ADMIN
  onboardingCompleted Boolean  @default(false)
  resetToken         String?   @unique
  resetTokenExpiry   DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  profiles           Profile[]
  accounts           Account[]
  sessions           Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id            String   @id @default(cuid())
  subdomain     String   @unique
  name          String
  about         String?
  logo          String?
  phone         String?
  whatsapp      String?
  email         String?
  address       String?
  mapEmbed      String?
  locationLat   Float?
  locationLng   Float?
  
  theme         String   @default("blue") // blue, emerald, coral, etc.
  language      String   @default("sk") // sk, cz, en, pl, hu
  avatarUrl     String?  // URL to profile picture
  bgImage       String?
  bgBlur        Boolean  @default(false)
  bgNoise       Boolean  @default(false)
  
  // Visual Customization
  iconStyle     String   @default("standard") // standard, black, white
  cardColor     String   @default("#ffffff")
  cardOpacity   Float    @default(1.0)
  cardTextColor String   @default("#000000")
  
  // Google Calendar Integration
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  BigInt?

  // Booking Settings
  allowConcurrentServices Boolean @default(false) // Allow bookings of different service types at the same time
  
  showBusinessCard Boolean @default(true) // Toggle to show/hide business card on profile
  
  seoTitle      String?
  seoDesc       String?
  
  // Subscription Management
  subscriptionStatus    String?   // ACTIVE, EXPIRED, CANCELLED, TRIAL
  subscriptionExpiresAt DateTime? // When the current subscription expires
  trialEndsAt           DateTime? // When trial period ends
  
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  
  services      Service[]
  socialLinks   SocialLink[]
  links         Link[]
  hours         WorkingHours[]
  bookings      Booking[]
  albums        GalleryAlbum[]
  documents     Document[]
  subscriptions Subscription[]
  subscriptionHistory SubscriptionHistory[]
  pageViews     PageView[]
  
  workers       Worker[]
  tables        Table[]
  floorPlan     FloorPlan?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tierId        String?
  tier          Tier?    @relation(fields: [tierId], references: [id])
}

model Tier {
  id            String   @id @default(cuid())
  name          String   @unique // Free, Business, Pro
  price         Decimal?
  features      TierFeature[]
  profiles      Profile[]
  subscriptions Subscription[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Feature {
  id          String   @id @default(cuid())
  key         String   @unique // e.g. "page_dashboard", "component_gallery", "page_seo"
  name        String   // Display name
  description String?
  tiers       TierFeature[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TierFeature {
  id        String   @id @default(cuid())
  tierId    String
  featureId String
  tier      Tier     @relation(fields: [tierId], references: [id], onDelete: Cascade)
  feature   Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([tierId, featureId])
}

model Service {
  id             String   @id @default(cuid())
  name           String
  description    String?
  price          Decimal?
  duration       Int      // in minutes
  currency       String   @default("EUR")
  bookingEnabled Boolean  @default(true) // Toggle to enable/disable bookings
  
  calendarType   CalendarType @default(HOURLY_SERVICE)
  
  // For DAILY_RENTAL
  minimumDays    Int?
  minimumValue   Decimal?
  pricePerDay    Decimal?
  
  // For TABLE_RESERVATION
  requiresTable  Boolean      @default(false)
  maxCapacity    Int?
  
  // Worker preferences
  allowWorkerSelection Boolean  @default(false)
  requireWorker        Boolean  @default(false)
  
  // Location settings (for HOURLY_SERVICE)
  locationType         String?  @default("business_address") // "business_address", "custom_address", "google_meet"
  customAddress        String?  // Used when locationType is "custom_address"
  
  profileId      String
  profile        Profile  @relation(fields: [profileId], references: [id])
  bookings       Booking[]
  categories     ServiceCategory[]
  workers        ServiceWorker[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model SocialLink {
  id        String   @id @default(cuid())
  platform  String   // facebook, instagram, etc.
  url       String
  
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id])
}

model Link {
  id        String   @id @default(cuid())
  title     String
  url       String
  order     Int      @default(0)
  
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkingHours {
  id        String   @id @default(cuid())
  dayOfWeek Int      // 0 = Sunday, 1 = Monday...
  openTime  String   // "09:00"
  closeTime String   // "17:00"
  isClosed  Boolean  @default(false)
  
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id])
}

model Booking {
  id          String   @id @default(cuid())
  customerName String
  customerEmail String
  customerPhone String?
  startTime   DateTime
  endTime     DateTime
  
  numberOfPeople Int?
  notes         String?
  
  categoryId    String?
  category      ServiceCategory? @relation(fields: [categoryId], references: [id])
  
  workerId      String?
  worker        Worker?  @relation(fields: [workerId], references: [id])
  
  tableId       String?
  table         Table?   @relation(fields: [tableId], references: [id])
  
  status        String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Showcase {
  id          String   @id @default(cuid())
  name        String   // Display name for the showcase
  imageUrl    String   // URL to the main phone screenshot
  profileUrl  String   // Link to the demo profile
  order       Int      @default(0) // For ordering showcases
  isActive    Boolean  @default(true)
  
  // Parallax layers support
  layers      ShowcaseLayer[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([order])
}

model ShowcaseLayer {
  id          String   @id @default(cuid())
  imageUrl    String   // URL to the layer image
  depth       Int      @default(0) // Parallax depth (0-100, higher = more movement)
  order       Int      @default(0) // Layer stacking order (0 = bottom)
  
  showcaseId  String
  showcase    Showcase @relation(fields: [showcaseId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([showcaseId])
  @@index([order])
}


model GalleryAlbum {
  id          String   @id @default(cuid())
  name        String
  description String?
  coverUrl    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  images      GalleryImage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([order])
}

model GalleryImage {
  id          String   @id @default(cuid())
  url         String
  caption     String?
  order       Int      @default(0)
  
  albumId     String
  album       GalleryAlbum @relation(fields: [albumId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([albumId])
  @@index([order])
}

model Document {
  id          String   @id @default(cuid())
  name        String   // Display name
  url         String   // File URL in Supabase
  fileType    String   // pdf, doc, docx, etc.
  fileSize    Int      // Size in bytes
  order       Int      @default(0)
  
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([order])
}

model Subscription {
  id                    String   @id @default(cuid())
  profileId             String
  profile               Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  tierId                String
  tier                  Tier     @relation(fields: [tierId], references: [id])
  
  status                String   @default("ACTIVE") // ACTIVE, CANCELLED, PAST_DUE, UNPAID
  
  // Stripe Integration
  stripeCustomerId      String?
  stripeSubscriptionId  String?  @unique
  stripePriceId         String?
  
  // Subscription Period
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  
  // Cancellation
  cancelAtPeriodEnd     Boolean  @default(false)
  cancelledAt           DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([profileId])
  @@index([stripeSubscriptionId])
}

model PromoCode {
  id                String   @id @default(cuid())
  code              String   @unique
  description       String?
  
  type              String   // PERCENTAGE, FIXED_AMOUNT, FREE_TRIAL_DAYS
  value             Decimal  // Percentage (0-100), amount in EUR, or number of days
  
  maxUses           Int?     // null = unlimited
  currentUses       Int      @default(0)
  
  validFrom         DateTime @default(now())
  validUntil        DateTime?
  
  isActive          Boolean  @default(true)
  
  // Optional: Restrict to specific tiers
  applicableTierIds String[] // Array of tier IDs
  
  subscriptionHistory SubscriptionHistory[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([code])
}

model SubscriptionHistory {
  id              String   @id @default(cuid())
  profileId       String
  profile         Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  action          String   // UPGRADED, DOWNGRADED, RENEWED, CANCELLED, EXPIRED, MANUAL_CHANGE
  
  previousTierId  String?
  newTierId       String?
  
  promoCodeId     String?
  promoCode       PromoCode? @relation(fields: [promoCodeId], references: [id])
  
  performedBy     String   // SYSTEM, ADMIN, USER
  performedByUserId String? // User ID if performed by admin/user
  
  notes           String?  // Additional context
  
  createdAt       DateTime @default(now())
  
  @@index([profileId])
  @@index([createdAt])
}

model PageView {
  id            String   @id @default(cuid())
  profileId     String
  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Visitor information
  visitorId     String   // Anonymous visitor ID (cookie/fingerprint)
  sessionId     String   // Session ID for grouping page views
  
  // Page information
  path          String   // Page path visited
  referrer      String?  // Where the visitor came from
  
  // Time tracking
  timeSpent     Int?     // Time spent on page in seconds
  
  // Device/Browser information
  userAgent     String?
  device        String?  // mobile, tablet, desktop
  browser       String?  // chrome, firefox, safari, etc.
  os            String?  // windows, mac, linux, ios, android
  
  // Location (optional, can be added later with IP geolocation)
  country       String?
  city          String?
  
  createdAt     DateTime @default(now())
  
  @@index([profileId])
  @@index([visitorId])
  @@index([sessionId])
  @@index([createdAt])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

enum CalendarType {
  HOURLY_SERVICE
  DAILY_RENTAL
  TABLE_RESERVATION
}

model Worker {
  id          String   @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  services    ServiceWorker[]
  bookings    Booking[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([order])
}

model ServiceCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal?
  duration    Int?
  order       Int      @default(0)
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  bookings    Booking[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([serviceId])
  @@index([order])
}

model ServiceWorker {
  id        String   @id @default(cuid())
  serviceId String
  workerId  String
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  worker    Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  
  @@unique([serviceId, workerId])
}

model Table {
  id          String   @id @default(cuid())
  name        String
  capacity    Int
  
  positionX   Float?
  positionY   Float?
  width       Float?
  height      Float?
  shape       String   @default("rectangle")
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  bookings    Booking[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
}

model FloorPlan {
  id          String   @id @default(cuid())
  name        String   @default("Main Floor")
  imageUrl    String?
  width       Int      @default(1000)
  height      Int      @default(800)
  
  profileId   String   @unique
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BlogPost {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  excerpt         String?  // Short description for previews
  content         String   @db.Text // Rich text content (HTML)
  featuredImage   String?  // URL to featured image
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Publishing
  isPublished     Boolean  @default(false)
  publishedAt     DateTime?
  
  // Author info
  authorName      String?
  authorImage     String?
  
  // Analytics
  viewCount       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([slug])
  @@index([isPublished])
  @@index([publishedAt])
}
